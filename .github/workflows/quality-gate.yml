# =====================================================
# Quality Gate (DoD判定)
# 組織の Reusable Workflow を呼び出す薄いラッパー
# =====================================================
#
# ロジックは組織リポジトリで一元管理:
# PROLE-ISLAND/.github/.github/workflows/reusable-quality-gate.yml
#
# CI完了後にPRの品質を判定してコメント投稿

name: 品質ゲート

on:
  workflow_run:
    workflows: [CI]
    types: [completed]

permissions:
  pull-requests: write
  statuses: write
  checks: write
  actions: read

jobs:
  # type:requirements ラベル付きPRはスキップ判定
  check-skip:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check.outputs.skip }}
    steps:
      - name: Check if requirements PR
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            // workflow_run からPR情報を取得
            const runId = context.payload.workflow_run?.id;
            if (!runId) {
              core.setOutput('skip', 'false');
              return;
            }

            // PR番号を取得
            const { data: run } = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });

            if (!run.pull_requests || run.pull_requests.length === 0) {
              core.setOutput('skip', 'false');
              return;
            }

            const prNumber = run.pull_requests[0].number;

            // PRのラベルを取得
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const hasRequirementsLabel = pr.labels.some(l => l.name === 'type:requirements');
            core.setOutput('skip', hasRequirementsLabel ? 'true' : 'false');

            if (hasRequirementsLabel) {
              console.log(`PR #${prNumber} has type:requirements label, skipping quality gate`);
            }

  quality-gate:
    needs: check-skip
    if: needs.check-skip.outputs.should_skip != 'true'
    uses: PROLE-ISLAND/.github/.github/workflows/reusable-quality-gate.yml@main
    with:
      language: 'ja'
      ci_workflow_name: 'CI'
      bronze_coverage: 80
      silver_coverage: 85
      gold_coverage: 95
