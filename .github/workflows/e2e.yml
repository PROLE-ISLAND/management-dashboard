# =====================================================
# Gold E2Eãƒ†ã‚¹ãƒˆ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ (Python/Playwright)
# dod:gold ãƒ©ãƒ™ãƒ«é§†å‹•ã§Gold E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
#
# ãƒˆãƒªã‚¬ãƒ¼:
#   - PR: dod:gold ãƒ©ãƒ™ãƒ«ä»˜ä¸æ™‚ã®ã¿å®Ÿè¡Œ
#   - push: mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸æ™‚ï¼ˆå¸¸ã«å®Ÿè¡Œï¼‰
#   - schedule: æ¯æ—¥9:00 JST
#   - workflow_dispatch: æ‰‹å‹•å®Ÿè¡Œ
# =====================================================

name: Gold E2Eãƒ†ã‚¹ãƒˆ

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, labeled]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰'
        required: false
        default: 'gold'
        type: choice
        options:
          - gold
          - smoke
  schedule:
    # Run daily at 9:00 JST (0:00 UTC)
    - cron: '0 0 * * *'

concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

permissions:
  contents: read
  pull-requests: write

jobs:
  # =====================================================
  # ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯ - å¿…é ˆSecretsã®ç¢ºèª
  # =====================================================
  check-env:
    name: ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    # PRã®å ´åˆ: dod:gold ãƒ©ãƒ™ãƒ«å¿…é ˆ
    # push/schedule/dispatch: å¸¸ã«å®Ÿè¡Œ
    if: |
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'dod:gold'))
    outputs:
      secrets_valid: ${{ steps.check.outputs.valid }}
    steps:
      - name: å¿…é ˆSecretsç¢ºèª
        id: check
        run: |
          # E2Eãƒ†ã‚¹ãƒˆã«å¿…è¦ãªSecretsã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½åŠ ï¼‰
          echo "valid=true" >> $GITHUB_OUTPUT
          echo "âœ… ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯å®Œäº†"

  # =====================================================
  # Gold E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  # =====================================================
  gold-e2e:
    name: Gold E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: ubuntu-latest
    needs: check-env
    # check-envã¨åŒã˜æ¡ä»¶
    if: |
      github.event_name == 'push' ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'dod:gold'))
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-playwright playwright

      - name: Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: playwright install --with-deps chromium

      - name: Reflexã‚¢ãƒ—ãƒªèµ·å‹•ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
        run: |
          reflex run --env prod &
          # ã‚¢ãƒ—ãƒªãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
          sleep 30
        env:
          # å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ 
          REFLEX_ENV_MODE: prod

      - name: Gold E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        id: e2e
        run: |
          if [[ "${{ inputs.test_mode }}" == "smoke" ]]; then
            echo "ğŸ”¥ Running smoke tests only"
            pytest e2e/ -m "smoke" -v --tb=short
          else
            echo "ğŸ¥‡ Running Gold E2E tests"
            pytest e2e/gold/ -v --tb=short || echo "No gold tests yet"
          fi
        continue-on-error: true  # åˆæœŸæ®µéšã§ã¯ãƒ†ã‚¹ãƒˆãŒãªã„å ´åˆãŒã‚ã‚‹

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results/
          retention-days: 30

      - name: PRå¤±æ•—é€šçŸ¥ã‚³ãƒ¡ãƒ³ãƒˆ
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## âŒ Gold E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ

            ### æ¦‚è¦
            Gold E2Eãƒ†ã‚¹ãƒˆï¼ˆ\`e2e/gold/\`ï¼‰ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

            ### ç¢ºèªæ‰‹é †
            1. [ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã‚’ç¢ºèª
            2. Artifactsã‹ã‚‰ \`playwright-report\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            3. ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’ä¿®æ­£ã—ã¦ãƒ—ãƒƒã‚·ãƒ¥

            ---
            <sub>ğŸ¤– Gold E2Eãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚‹è‡ªå‹•é€šçŸ¥</sub>`;

            // æ—¢å­˜ã®å¤±æ•—ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c =>
              c.body.includes('Gold E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ') &&
              c.user.type === 'Bot'
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: PRæˆåŠŸé€šçŸ¥ã‚³ãƒ¡ãƒ³ãƒˆ
        if: success() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## âœ… Gold E2Eãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ

            Gold E2Eãƒ†ã‚¹ãƒˆï¼ˆ\`e2e/gold/\`ï¼‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚

            [ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) ã§è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™ã€‚

            ---
            <sub>ğŸ¤– Gold E2Eãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚‹è‡ªå‹•é€šçŸ¥</sub>`;

            // æ—¢å­˜ã®æˆåŠŸ/å¤±æ•—ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢ã—ã¦æ›´æ–°
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c =>
              (c.body.includes('Gold E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ') || c.body.includes('Gold E2Eãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ')) &&
              c.user.type === 'Bot'
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
