# =====================================================
# çµ„ç¹”ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŒæœŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# PROLE-ISLAND/.github ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨åŒæœŸ
# =====================================================
#
# ä½¿ç”¨æ–¹æ³•:
# 1. ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ .github/workflows/sync-templates.yml ã«ã‚³ãƒ”ãƒ¼
# 2. å¿…è¦ã«å¿œã˜ã¦ .github/CODEOWNERS.local, .github/dependabot.local.yml ã‚’ä½œæˆ
#
# å‹•ä½œ:
# - é€±1å›ï¼ˆæœˆæ›œ09:00 JSTï¼‰è‡ªå‹•å®Ÿè¡Œ
# - æ‰‹å‹•å®Ÿè¡Œ: Actions â†’ Sync Templates â†’ Run workflow
# - çµ„ç¹”ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ + ãƒ­ãƒ¼ã‚«ãƒ«æ‹¡å¼µã‚’ãƒãƒ¼ã‚¸
#
# å‚è€ƒ: docs/TEMPLATE_SYNC_GUIDE.md

name: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŒæœŸ

on:
  schedule:
    # æ¯é€±æœˆæ›œ 09:00 JST (00:00 UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (å¤‰æ›´ã‚’é©ç”¨ã›ãšå·®åˆ†ã®ã¿è¡¨ç¤º)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-templates:
    name: çµ„ç¹”ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåŒæœŸ
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch organization templates
        run: |
          mkdir -p .github/templates-cache

          # CODEOWNERS ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå–å¾—
          curl -sL -o .github/templates-cache/CODEOWNERS_TEMPLATE.md \
            https://raw.githubusercontent.com/PROLE-ISLAND/.github/main/CODEOWNERS_TEMPLATE.md

          # Dependabot ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå–å¾—
          curl -sL -o .github/templates-cache/dependabot.yml.template \
            https://raw.githubusercontent.com/PROLE-ISLAND/.github/main/dependabot.yml.template

          echo "âœ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå–å¾—å®Œäº†"

      - name: Merge CODEOWNERS
        run: |
          TEMPLATE=".github/templates-cache/CODEOWNERS_TEMPLATE.md"
          LOCAL=".github/CODEOWNERS.local"
          OUTPUT=".github/CODEOWNERS"

          echo "# =====================================================" > "$OUTPUT"
          echo "# CODEOWNERS - è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«" >> "$OUTPUT"
          echo "# çµ„ç¹”ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ + ãƒ­ãƒ¼ã‚«ãƒ«æ‹¡å¼µã®ãƒãƒ¼ã‚¸çµæœ" >> "$OUTPUT"
          echo "# " >> "$OUTPUT"
          echo "# ç·¨é›†æ–¹æ³•:" >> "$OUTPUT"
          echo "#   - çµ„ç¹”å…±é€šãƒ«ãƒ¼ãƒ«: PROLE-ISLAND/.github ã® CODEOWNERS_TEMPLATE.md" >> "$OUTPUT"
          echo "#   - ãƒªãƒã‚¸ãƒˆãƒªå›ºæœ‰ãƒ«ãƒ¼ãƒ«: .github/CODEOWNERS.local ã«è¿½è¨˜" >> "$OUTPUT"
          echo "# =====================================================" >> "$OUTPUT"
          echo "" >> "$OUTPUT"

          # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ã‚³ãƒ¡ãƒ³ãƒˆä»¥å¤–ã‚’æŠ½å‡º
          echo "# === çµ„ç¹”å…±é€šãƒ«ãƒ¼ãƒ« ===" >> "$OUTPUT"
          grep -v "^#" "$TEMPLATE" | grep -v "^$" | head -20 >> "$OUTPUT" || true
          echo "" >> "$OUTPUT"

          # ãƒ­ãƒ¼ã‚«ãƒ«æ‹¡å¼µãŒã‚ã‚Œã°è¿½åŠ 
          if [ -f "$LOCAL" ]; then
            echo "# === ãƒªãƒã‚¸ãƒˆãƒªå›ºæœ‰ãƒ«ãƒ¼ãƒ« ===" >> "$OUTPUT"
            grep -v "^#" "$LOCAL" | grep -v "^$" >> "$OUTPUT" || true
            echo "âœ“ ãƒ­ãƒ¼ã‚«ãƒ«æ‹¡å¼µã‚’é©ç”¨: $LOCAL"
          else
            echo "â„¹ ãƒ­ãƒ¼ã‚«ãƒ«æ‹¡å¼µãªã—ï¼ˆ.github/CODEOWNERS.local ãŒå­˜åœ¨ã—ãªã„ï¼‰"
          fi

          echo "âœ“ CODEOWNERS ãƒãƒ¼ã‚¸å®Œäº†"

      - name: Merge dependabot.yml
        run: |
          TEMPLATE=".github/templates-cache/dependabot.yml.template"
          LOCAL=".github/dependabot.local.yml"
          OUTPUT=".github/dependabot.yml"

          # Python ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§YAMLãƒãƒ¼ã‚¸
          python3 << 'PYTHON_SCRIPT'
          import yaml
          import os

          template_path = ".github/templates-cache/dependabot.yml.template"
          local_path = ".github/dependabot.local.yml"
          output_path = ".github/dependabot.yml"

          # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
          with open(template_path, 'r') as f:
              # ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦YAMLéƒ¨åˆ†ã®ã¿æŠ½å‡º
              content = f.read()
              # æœ€åˆã® "version:" ã‹ã‚‰é–‹å§‹
              yaml_start = content.find('version:')
              if yaml_start == -1:
                  print("Error: version: not found in template")
                  exit(1)
              yaml_content = content[yaml_start:]
              base = yaml.safe_load(yaml_content)

          # ãƒ­ãƒ¼ã‚«ãƒ«æ‹¡å¼µèª­ã¿è¾¼ã¿
          local_groups = {}
          local_updates = []
          if os.path.exists(local_path):
              with open(local_path, 'r') as f:
                  local = yaml.safe_load(f)
                  if local:
                      local_groups = local.get('groups', {})
                      local_updates = local.get('updates', [])
              print(f"âœ“ ãƒ­ãƒ¼ã‚«ãƒ«æ‹¡å¼µã‚’èª­ã¿è¾¼ã¿: {local_path}")
          else:
              print("â„¹ ãƒ­ãƒ¼ã‚«ãƒ«æ‹¡å¼µãªã—")

          # ãƒãƒ¼ã‚¸å‡¦ç†
          if base and 'updates' in base:
              for update in base['updates']:
                  if update.get('package-ecosystem') == 'pip':
                      # groups ã«ãƒ­ãƒ¼ã‚«ãƒ«æ‹¡å¼µã‚’è¿½åŠ 
                      if 'groups' not in update:
                          update['groups'] = {}
                      for group_name, group_config in local_groups.items():
                          if group_name not in update['groups']:
                              update['groups'][group_name] = group_config
                              print(f"  + ã‚°ãƒ«ãƒ¼ãƒ—è¿½åŠ : {group_name}")

          # ãƒ­ãƒ¼ã‚«ãƒ«ã®è¿½åŠ updatesï¼ˆDockerç­‰ï¼‰ã‚’ãƒãƒ¼ã‚¸
          if local_updates:
              for local_update in local_updates:
                  # åŒã˜ ecosystem ãŒãªã‘ã‚Œã°è¿½åŠ 
                  ecosystem = local_update.get('package-ecosystem')
                  existing = [u for u in base.get('updates', []) if u.get('package-ecosystem') == ecosystem]
                  if not existing:
                      base['updates'].append(local_update)
                      print(f"  + ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ è¿½åŠ : {ecosystem}")

          # å‡ºåŠ›
          header = """# =====================================================
          # dependabot.yml - è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«
          # çµ„ç¹”ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ + ãƒ­ãƒ¼ã‚«ãƒ«æ‹¡å¼µã®ãƒãƒ¼ã‚¸çµæœ
          #
          # ç·¨é›†æ–¹æ³•:
          #   - çµ„ç¹”å…±é€šè¨­å®š: PROLE-ISLAND/.github ã® dependabot.yml.template
          #   - ãƒªãƒã‚¸ãƒˆãƒªå›ºæœ‰è¨­å®š: .github/dependabot.local.yml ã«è¿½è¨˜
          # =====================================================

          """
          with open(output_path, 'w') as f:
              f.write(header)
              yaml.dump(base, f, default_flow_style=False, allow_unicode=True, sort_keys=False)

          print("âœ“ dependabot.yml ãƒãƒ¼ã‚¸å®Œäº†")
          PYTHON_SCRIPT

      - name: Cleanup cache
        run: rm -rf .github/templates-cache

      - name: Check for changes
        id: diff
        run: |
          git add .github/CODEOWNERS .github/dependabot.yml
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ å¤‰æ›´ãªã—"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ“ å¤‰æ›´ã‚’æ¤œå‡º"
            git diff --cached --stat
          fi

      - name: Show diff (dry run)
        if: inputs.dry_run == 'true' && steps.diff.outputs.changed == 'true'
        run: |
          echo "=== Dry Run: ä»¥ä¸‹ã®å¤‰æ›´ãŒé©ç”¨ã•ã‚Œã¾ã™ ==="
          git diff --cached

      - name: Create Pull Request
        if: inputs.dry_run != 'true' && steps.diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: çµ„ç¹”ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨åŒæœŸ"
          branch: chore/sync-templates
          delete-branch: true
          title: "chore: çµ„ç¹”ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨åŒæœŸ"
          body: |
            ## æ¦‚è¦

            PROLE-ISLAND/.github ã®æœ€æ–°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨åŒæœŸã—ã¾ã—ãŸã€‚

            ### å¤‰æ›´å†…å®¹

            - CODEOWNERS: çµ„ç¹”ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ + ãƒ­ãƒ¼ã‚«ãƒ«æ‹¡å¼µã®ãƒãƒ¼ã‚¸
            - dependabot.yml: çµ„ç¹”ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ + ãƒ­ãƒ¼ã‚«ãƒ«æ‹¡å¼µã®ãƒãƒ¼ã‚¸

            ### ç¢ºèªäº‹é …

            - [ ] CODEOWNERS ã®ãƒãƒ¼ãƒ åãŒæ­£ã—ã„ã‹
            - [ ] dependabot.yml ã®ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šãŒé©åˆ‡ã‹

            ---

            ğŸ¤– ã“ã® PR ã¯ [sync-templates.yml](https://github.com/PROLE-ISLAND/.github/blob/main/workflow-templates/sync-templates.yml) ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
          labels: |
            dependencies
            automated
