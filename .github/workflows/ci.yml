# =====================================================
# CI ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆçµ„ç¹”ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
# PRãƒ»ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«å®Ÿè¡Œ: lint, å‹ãƒã‚§ãƒƒã‚¯, å˜ä½“ãƒ†ã‚¹ãƒˆ, ãƒ“ãƒ«ãƒ‰
# DoD Bronze åŸºæº–ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯
# =====================================================

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # DoD Bronze ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤
  COVERAGE_THRESHOLD: 80

jobs:
  # ===========================================
  # A2: Linté€šé
  # ===========================================
  lint:
    name: ğŸ”· A2: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint

  # ===========================================
  # A1: å‹å®‰å…¨æ€§
  # ===========================================
  type-check:
    name: ğŸ”· A1: å‹ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx tsc --noEmit

  # ===========================================
  # B1-B9: ãƒ†ã‚¹ãƒˆé–¢é€£
  # ===========================================
  unit-test:
    name: ğŸ§ª B1-B9: å˜ä½“ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run test:coverage
        id: test

      # B2: ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ãƒã‚§ãƒƒã‚¯
      - name: ğŸ“Š B2: ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ãƒã‚§ãƒƒã‚¯ (â‰§${{ env.COVERAGE_THRESHOLD }}%)
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
            echo "Coverage: $COVERAGE%"

            if (( $(echo "$COVERAGE < ${{ env.COVERAGE_THRESHOLD }}" | bc -l) )); then
              echo "::error::Coverage $COVERAGE% is below threshold (${{ env.COVERAGE_THRESHOLD }}%)"
              exit 1
            fi

            echo "âœ… Coverage $COVERAGE% meets threshold"
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          else
            echo "::warning::coverage-summary.json not found"
          fi
        id: coverage

      # Codecov ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - uses: codecov/codecov-action@v4
        with:
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒãƒƒã‚¸ã‚’ã‚µãƒãƒªãƒ¼ã«è¿½åŠ 
      - name: ğŸ“ Test Summary
        if: always()
        run: |
          echo "## ğŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
            echo "**Coverage**: $COVERAGE%" >> $GITHUB_STEP_SUMMARY
            if (( $(echo "$COVERAGE >= ${{ env.COVERAGE_THRESHOLD }}" | bc -l) )); then
              echo "âœ… Meets DoD Bronze threshold (${{ env.COVERAGE_THRESHOLD }}%)" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Below DoD Bronze threshold (${{ env.COVERAGE_THRESHOLD }}%)" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  # ===========================================
  # K1: ãƒ“ãƒ«ãƒ‰é€šé
  # ===========================================
  build:
    name: ğŸ—ï¸ K1: ãƒ“ãƒ«ãƒ‰
    runs-on: ubuntu-latest
    needs: [lint, type-check, unit-test]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run build

  # ===========================================
  # DoD Bronze Gate ã‚µãƒãƒªãƒ¼
  # ===========================================
  bronze-summary:
    name: ğŸ¥‰ Bronze Gate
    runs-on: ubuntu-latest
    needs: [lint, type-check, unit-test, build]
    if: always()
    steps:
      - name: ğŸ“ Bronze Gate Summary
        run: |
          echo "## ğŸ¥‰ DoD Bronze Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | DoD | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | A2 | ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check | A1 | ${{ needs.type-check.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Test | B1-B9 | ${{ needs.unit-test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | K1 | ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.lint.result }}" == "success" ] && \
             [ "${{ needs.type-check.result }}" == "success" ] && \
             [ "${{ needs.unit-test.result }}" == "success" ] && \
             [ "${{ needs.build.result }}" == "success" ]; then
            echo "### âœ… Bronze Gate PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Bronze Gate FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> è©³ç´°: [DoD_STANDARDS.md](https://github.com/PROLE-ISLAND/.github/blob/main/DoD_STANDARDS.md)" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Fail if Bronze Gate Failed
        if: |
          needs.lint.result != 'success' ||
          needs.type-check.result != 'success' ||
          needs.unit-test.result != 'success' ||
          needs.build.result != 'success'
        run: exit 1
