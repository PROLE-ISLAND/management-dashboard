# =====================================================
# CI ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆPython/Reflex ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨ï¼‰
# PRãƒ»ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«å®Ÿè¡Œ: lint, å‹ãƒã‚§ãƒƒã‚¯, å˜ä½“ãƒ†ã‚¹ãƒˆ, ãƒ“ãƒ«ãƒ‰
# DoD Bronze åŸºæº–ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯
# =====================================================

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  # DoD Bronze ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤
  COVERAGE_THRESHOLD: 80

jobs:
  # ===========================================
  # A2: Linté€šéï¼ˆruffï¼‰
  # ===========================================
  lint:
    name: "ğŸ”· A2: Lint"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run ruff check
        run: ruff check .

      - name: Run ruff format check
        run: ruff format --check .

  # ===========================================
  # A1: å‹å®‰å…¨æ€§ï¼ˆmypyï¼‰
  # ===========================================
  type-check:
    name: "ğŸ”· A1: å‹ãƒã‚§ãƒƒã‚¯"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install mypy

      - name: Run mypy
        run: mypy management_dashboard/ --ignore-missing-imports
        continue-on-error: true  # Reflex ã®å‹å®šç¾©ãŒä¸å®Œå…¨ãªå ´åˆãŒã‚ã‚‹ãŸã‚

  # ===========================================
  # B1-B9: ãƒ†ã‚¹ãƒˆé–¢é€£
  # ===========================================
  unit-test:
    name: "ğŸ§ª B1-B9: å˜ä½“ãƒ†ã‚¹ãƒˆ"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run tests with coverage
        run: |
          pytest tests/ \
            --cov=management_dashboard \
            --cov-report=xml \
            --cov-report=json \
            --cov-report=term-missing \
            -v || echo "No tests found yet"
        id: test

      # B2: ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ãƒã‚§ãƒƒã‚¯
      - name: "ğŸ“Š B2: ã‚«ãƒãƒ¬ãƒƒã‚¸é–¾å€¤ãƒã‚§ãƒƒã‚¯ (â‰§${{ env.COVERAGE_THRESHOLD }}%)"
        run: |
          if [ -f coverage.json ]; then
            COVERAGE=$(python -c "import json; d=json.load(open('coverage.json')); print(d.get('totals', {}).get('percent_covered', 0))")
            echo "Coverage: $COVERAGE%"

            if (( $(echo "$COVERAGE < ${{ env.COVERAGE_THRESHOLD }}" | bc -l) )); then
              echo "::warning::Coverage $COVERAGE% is below threshold (${{ env.COVERAGE_THRESHOLD }}%)"
            else
              echo "âœ… Coverage $COVERAGE% meets threshold"
            fi
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          else
            echo "::warning::coverage.json not found (no tests yet)"
          fi
        id: coverage
        continue-on-error: true

      # Codecov ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - uses: codecov/codecov-action@v4
        with:
          fail_ci_if_error: false
          files: ./coverage.xml
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        if: always()

      # ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚µãƒãƒªãƒ¼
      - name: ğŸ“ Test Summary
        if: always()
        run: |
          echo "## ğŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage.json ]; then
            COVERAGE=$(python -c "import json; d=json.load(open('coverage.json')); print(d.get('totals', {}).get('percent_covered', 0))")
            echo "**Coverage**: $COVERAGE%" >> $GITHUB_STEP_SUMMARY
            if (( $(echo "$COVERAGE >= ${{ env.COVERAGE_THRESHOLD }}" | bc -l) )); then
              echo "âœ… Meets DoD Bronze threshold (${{ env.COVERAGE_THRESHOLD }}%)" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ Below DoD Bronze threshold (${{ env.COVERAGE_THRESHOLD }}%)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ No test coverage data (tests not implemented yet)" >> $GITHUB_STEP_SUMMARY
          fi

  # ===========================================
  # K1: ãƒ“ãƒ«ãƒ‰é€šéï¼ˆReflex Exportï¼‰
  # ===========================================
  build:
    name: "ğŸ—ï¸ K1: ãƒ“ãƒ«ãƒ‰"
    runs-on: ubuntu-latest
    needs: [lint]  # lintãŒé€šã‚Œã°ä¸¦è¡Œå®Ÿè¡Œ
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set up Node.js (for Reflex frontend build)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Reflex init check
        run: |
          cd ${{ github.workspace }}
          reflex init --loglevel debug 2>&1 || true

      - name: Build Reflex app
        run: |
          reflex export --no-zip
        continue-on-error: true  # åˆæœŸæ®µéšã§ã¯exportãŒå¤±æ•—ã™ã‚‹å ´åˆãŒã‚ã‚‹

  # ===========================================
  # DoD Bronze Gate ã‚µãƒãƒªãƒ¼
  # ===========================================
  bronze-summary:
    name: ğŸ¥‰ Bronze Gate
    runs-on: ubuntu-latest
    needs: [lint, type-check, unit-test, build]
    if: always()
    steps:
      - name: ğŸ“ Bronze Gate Summary
        run: |
          echo "## ğŸ¥‰ DoD Bronze Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | DoD | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint (ruff) | A2 | ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check (mypy) | A1 | ${{ needs.type-check.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Test (pytest) | B1-B9 | ${{ needs.unit-test.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build (reflex) | K1 | ${{ needs.build.result == 'success' && 'âœ…' || 'âš ï¸' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Lint ã¯å¿…é ˆã€ä»–ã¯è­¦å‘Šãƒ¬ãƒ™ãƒ«ï¼ˆåˆæœŸé–‹ç™ºæ®µéšã®ãŸã‚ï¼‰
          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "### âœ… Bronze Gate PASSED (Lint OK)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> Note: Type check, tests, build are advisory during initial development" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Bronze Gate FAILED (Lint Failed)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> è©³ç´°: [DoD_STANDARDS.md](https://github.com/PROLE-ISLAND/.github/blob/main/DoD_STANDARDS.md)" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Fail if Lint Failed
        if: needs.lint.result != 'success'
        run: exit 1
